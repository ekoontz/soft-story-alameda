<!DOCTYPE html>
<html>
<head>
  <title>Soft Story Buildings in Alameda, CA</title>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <!-- STYLES -->
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <link rel="stylesheet" type="text/css" href="css/styles.css">

  <!-- SCRIPTS -->
  <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

</head>
<body>
  <div id="map"></div>

  <script>

    var map = L.map('map').setView([37.766202813376644, -122.26006507873535], 14);

    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    $.getJSON("./latlonglookup.json", function(latlonglookup) {

      $.getJSON("http://www.civicdata.com/api/action/datastore_search?resource_id=46ec0807-31ff-497f-bfa0-f31c796cdee8", function(buildingdata_page1) {

        $.getJSON("http://www.civicdata.com/api/action/datastore_search?offset=100&resource_id=46ec0807-31ff-497f-bfa0-f31c796cdee8", function(buildingdata_page2) {

            all_buildings = [].concat(buildingdata_page1['result']['records']).concat(buildingdata_page2['result']['records']);

            _.each(all_buildings, function(item){
            key = item['PermitNumber'];
            latlong = latlonglookup[key];
            L.marker(latlong).addTo(map).bindPopup(item['StreetAddress'] + '<br><br>' + item['Description']);
            });

          });
      });
    });

  </script>
</body>
</html>
